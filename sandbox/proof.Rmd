---
title: "Proof of Concept: Causal Mediation for Stochastic Interventions"
author: "Ivan Diaz and [Nima Hejazi](https://nimahejazi.org)"
date: "`r Sys.Date()`"
output:
  rmarkdown::pdf_document:
    latex_engine: xelatex
---

```{r prelim, echo=FALSE, message=FALSE}
# plotting and scientific notation
#options(repr.plot.width = 4, repr.plot.height = 3)  ## resizing plots
options(scipen = 999)  ## has scientific notation ever annoyed you?

# packages
#library(tidyverse)  # pandoc can't deal with the startup message
library(tibble)
library(stringr)
library(ggplot2)
library(data.table)
library(condensier)
library(SuperLearner)
library(sl3)
library(tmle3)
library(txshift)
library(npcausal)
library(future)
library(here)
load_all()

# parallelization and prng
plan(multiprocess)
set.seed(429153)
```

```{r make_learners}
# SL learners used for most fits (e.g., propensity score, outcome regression)
lrnr_lib <- make_learner_stack("Lrnr_mean", "Lrnr_glm_fast", "Lrnr_ranger")
sl_lrn <- Lrnr_sl$new(learners = lrnr_lib, metalearner = Lrnr_nnls$new())
```

# Background

We are interested in assessing the Natural Direct Effect (NDE) and the Natural
Indirect Effect (NIE), based on the following decomposition of the population
mediated intervention mean:

\begin{equation*}
  \Psi_0 = \mathbb{E}_0{Y(g_0,q_0)} − \mathbb{E}_0{Y(g_{0,\delta},q_0)} +
  \mathbb{E}_0{Y(g_{0,\delta},q_0)} +
  \mathbb{E}_0{Y(g_{0,\delta} ,q_{0,\delta})},
\end{equation*}
where, in the sequel, we denote $\mu_0 = \mathbb{E}_0{Y(g_0,q_0)}$,
$\beta_0 = \mathbb{E}_0{Y(g_{0,\delta},q_0)}$,
$\theta_0 = \mathbb{E}_0{Y(g_{0,\delta} ,q_{0,\delta})}$, and thus
\begin{equation}\label{eqn:decomp}
\Psi_0 = \mu_0 − \beta_0 + \beta_0 + \theta_0.
\end{equation}

In order compute $\Psi_0$, consistent and efficient estimates of the three
constituent terms is necessary. While estimation of $\mu_0$ is trivial, and
prior work (i.e., Diaz & van der Laan, 2012 + 2018) has built TML estimators
(amongst others) of $\theta_0$, it remains to estimate $\beta_0$.

---

# Simple Example with Binary Intervention


```{r sim_example_data}
# simulate simple data for simple simulation
n_obs <- 1000  # number of observations
n_w <- 3  # number of baseline covariates
p_w <- 0.5  # probability of a success ("1") in the baseline variables
tx_mult <- 2  # multiplier for the effect of W = 1 on the treatment
delta_shift <- 0.5  # posited value of the shift parameter

# baseline covariate -- simple, binary
W <- as.matrix(replicate(n_w, rbinom(n_obs, 1, prob = p_w)))

# create treatment based on baseline W
A <- as.numeric(rbinom(n_obs, 1, prob = (rowSums(W)/5 + 0.1)))

# mediators to affect the outcome
## 1st mediator (binary)
z1_prob <-(A + rowSums(W) + runif(n_obs, 0, 0.1)) / max(A + rowSums(W) + 0.1)
Z_1 <- rbinom(n_obs, 1, prob = z1_prob)
## 2nd mediator (binary)
z2_form <- (A - 1)^3 + W[, 2] - W[, 3] + runif(n_obs, 0, 0.2)
z2_prob <- abs(z2_form) / max(abs(z2_form))
z2_prob <- z2_prob + runif(n_obs, 0, 1 - max(z2_prob))
Z_2 <- rbinom(n_obs, 1, prob = z2_prob)
## 3rd mediator (binary)
z3_form <- (A - 1) + rnorm(n_obs)
z3_prob <- abs(z3_form) / max(abs(z3_form))
Z_3 <- rbinom(n_obs, 1, prob = z3_prob)

# create outcome as a linear function of A, W + white noise
Y <- Z_1 + Z_2 - Z_3 + A - rowSums(W) + rnorm(n_obs, mean = 0, sd = 1)
```

```{r make_data_structs}
# full data structure
data <- as.data.table(cbind(Y, Z_1, Z_2, Z_3, A, W))
setnames(data, c("Y", paste("Z", 1:3, sep = "_"), "A",
                paste("W", seq_len(dim(W)[2]), sep = "_")))
head(data)

# column names for sl3 tasks (for convenience)
z_names <- colnames(data)[str_detect(colnames(data), "Z")]
w_names <- colnames(data)[str_detect(colnames(data), "W")]

# make NPSEM and tmle3 task
npsem <- list(define_node("W", w_names),
              define_node("A", "A", c("W")),
              define_node("Z", z_names, c("A", "W")),
              define_node("Y", "Y", c("Z", "A", "W"))
             )
tmle_task <- tmle3_Task$new(data, npsem = npsem)
```


## Estimation of the mean outcome

NOTE: need this as a component of the decomposition

```{r compute_EY}
# just the population mean of the outcome
EY <- mean(Y)
```


## Estimation of $\theta_0$

$$\theta_0 = \int b_0(a, w) g_{0,\delta}(a \mid w) p_0(w) d\nu(a, w),$$
for which a nonparametric-efficient estimator may be computed, e.g., by using
https://github.com/ehkennedy/npcausal.

```{r est_npcausal}
# let's compute theta_0 by fitting its TMLE
theta_ipsi <- ipsi(y = data$Y, a = data$A, x.trt = W, x.out = W,
                   time = rep(1, nrow(data)), id = seq_along(Y),
                   delta.seq = delta_shift)

# print return object and extract point estimate
theta_ipsi$res
theta_ipsi_est <- theta_ipsi$res$est
```


## Estimation of $\theta_0$

$$\theta_0 = \int m_0(a, z, w) g_{0,\delta}(a \mid w) p_0(z, w) d\nu(a, z,
w),$$ for which we seek to build an estimator.

_Efficient influence function_: Define $\eta = (g, m, e, \phi)$. The efficient
influence function for estimation of $\beta_0$ in the nonparametric model
$\mathcal{M}$ is given by
$D_{\eta,\beta}(o) = D_{Y,\eta}(o) + D_{A,\eta}(o) + D_{Z,W,\eta,\beta}(o)$,
where
$$D_{Y,\eta}(o) = \frac{g_{\delta}(a \mid w)}{e(a | z, w)}\left(y −
m(z, a, w)\right),$$ and
$$D_{Z,W,\eta,\beta}(o) = \int m(z, a, w) g_{\delta}(a \mid w)d\nu(a) −
\beta,$$ and $D_{A,\eta}(O)$ is the efficient influence function in the
nonparametric model for $g_{\delta,0}$.

First, let compute an estimate of the treatment mechanism $g(A \mid W)$:

```{r compute_g}
g_est <- fit_g_mech(task = tmle_task, delta_shift = 0.5,
                    lrnr_stack = sl_lrn)
g_est
```

Let's take a quick look at our predictions, to check stability:

```{r plot_stability_g, out.width = '75%'}
p_hist_g_natural <- ggplot(as_tibble(g_est$g_natural), aes(x = value)) +
  geom_histogram() + theme_bw() + xlab("est. g(a | w)")
p_hist_g_natural

p_hist_g_shifted <- ggplot(as_tibble(g_est$g_shifted), aes(x = value)) +
  geom_histogram() + theme_bw() + xlab("est. g(a + shift | w)")
p_hist_g_shifted
```

Let's now compute an estimate of the treatment mechanism, conditional on both
the baseline covariates and mediators $\hat{e}(A \mid Z, W)$:

```{r compute_e}
# make task for treatment mechanism, conditional on mediators
e_est <- fit_e_mech(task = tmle_task, lrnr_stack = sl_lrn)
e_est
```

Let's take a quick look at our predictions, to check stability:

```{r plot_stability_e, out.width = '75%'}
p_hist_e <- ggplot(as_tibble(e_est$e_mech), aes(x = value)) +
  geom_histogram() + theme_bw() + xlab("est. e(a | z, w)")
p_hist_e
```

Next, let's compute an estimate of the outcome regression $m(a, z, w)$:

```{r compute_m}
m_est <- fit_m_mech(task = tmle_task, lrnr_stack = sl_lrn)
m_est
```

Let's take a quick look at our predictions, to check stability:

```{r plot_stability_m, out.width = '75%'}
p_hist_m <- ggplot(as_tibble(m_est$m_pred), aes(x = value)) +
  geom_histogram() + theme_bw() + xlab("est. m(a, z, w)")
p_hist_m
```

**Fitting the substitution estimator $\hat{\theta}_{\text{sub}}(\delta)$**

\begin{equation*}
  \hat{\theta}_{\text{sub}}(\delta) = \int \frac{1}{n} \sum_{i = 1}^n
    \hat{m}(a, Z_i, W_i) \hat{g}_{\delta}(a \mid W_i) d\kappa(a)
\end{equation*}

```{r substitution_est}
theta_sub <- estim_sub(task = tmle_task, delta_shift = delta_shift,
                       lrnr_stack = sl_lrn)
theta_sub
```


**Fitting the re-weighted estimator $\hat{\theta}_{\text{re}}(\delta)$**

\begin{equation*}
  \hat{\theta}_{\text{re}}(\delta) = \frac{1}{n} \sum_{i = 1}^n
  \frac{\hat{g}_{\delta}(A_i \mid W_i)}{\hat{e}(A_i \mid Z_i, W_i)} Y_i
\end{equation*}

```{r reweighted_est}
# fit the re-weighted estimator
theta_re <- estim_reweighted(task = tmle_task, delta_shift = delta_shift,
                             lrnr_stack = sl_lrn)
theta_re
```

**Fitting the efficient estimator $\hat{\theta}(\delta)$**

\begin{equation*}
  \hat{\theta}(\delta) = \frac{1}{n} \sum_{i = 1}^n D_{\hat{\eta}_{j(i)},
  \delta}(O_i) = \frac{1}{n} \sum_{i = 1}^n \left\{ D^Y_{\hat{\eta}_{j(i)},
  \delta}(O_i) + D^A_{\hat{\eta}_{j(i)}, \delta}(O_i) +
  D^{Z,W}_{\hat{\eta}_{j(i)}, \delta}(O_i) \right\}
\end{equation*}

```{r efficient_est}
# TODO
```

**Estimate of the Natural Direct Effect $\beta_{\text{NDE}}(\delta)$**

From the introduction, we note that the _natural direct effect_ (NDE) may be
denoted $\beta_0(\delta) = \mathbb{E}Y - \theta_0(\delta)$. Thus, an estimator
of the NDE, $\hat{\beta}(\delta)$ may be expressed

\begin{equation*}
  \hat{\beta}_{\text{NDE}}({\delta}) = \frac{1}{n} \sum_{i = 1}^n Y_i -
  \hat{\theta}(\delta).
\end{equation*}
Letting $\hat{\theta}(\delta)$ be $\hat{\theta}(\delta)_{\text{sub}}$, we can
construct an estimator of the NDE from the quantities already computed.

```{r comp_nde_binary}
beta_nde <- EY - theta_sub
beta_nde
```

**Estimate of the Natural Indirect Effect $\beta_{\text{NIE}}(\delta)$**

From the introduction, we note that the _natural indirect effect_ (NIE) may be
denoted $\beta_0(\delta) = \theta_0(\delta) - \mathbb{E}Y_{g_{0, \delta}, q_{0,
\delta}}$. Thus, an estimator of the NDE, $\hat{\beta}_{\text{NIE}}(\delta)$
may be expressed

\begin{equation*}
  \hat{\beta}_{\text{NIE}}({\delta}) = \hat{\theta}(\delta) -
  \hat{\theta}_{\text{IPSI}}(\delta).
\end{equation*}
Letting $\hat{\theta}(\delta)$ be $\hat{\theta}(\delta)_{\text{sub}}$, we can
construct an estimator of the NIE from the quantities already computed.

```{r comp_nie_binary}
beta_nie <- theta_sub - theta_ipsi_est
beta_nie
```

